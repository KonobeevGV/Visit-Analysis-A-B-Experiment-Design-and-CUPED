# Pet Project: Анализ визитов + Дизайн A/B-экспериментов и CUPED

![Python](https://img.shields.io/badge/Python-3.10%2B-blue)
![A/B Testing](https://img.shields.io/badge/A_B_Testing-Power%20%26%20CUPED-orange)
![CUPED](https://img.shields.io/badge/CUPED-Variance%20Reduction-brightgreen)

---

## Описание проекта

Этот pet-проект — это **полноценное исследование поведения пользователей** на сайте [teach-in.ru](https://teach-in.ru) на основе данных с 2021 по 2025 год.

Проект состоит из **двух ключевых частей**:

1. **Исследовательский анализ данных (EDA)**  
   → Понимание структуры трафика, поведения пользователей, сезонности, географии.

2. **Дизайн A/B-экспериментов и снижение дисперсии (CUPED)**  
   → Симуляция A/B-тестов, проверка корректности, мощности, MDE, применение методов уменьшения дисперсии.

---

## Данные

- **Файл**: `data.tsv` (TSV-формат, ~387k строк)

Ключевые поля:

| Поле | Описание |
|------|---------|
| `visitID` | Уникальный ID визита |
| `clientID` | Уникальный ID пользователя |
| `dateTimeUTC` | Время начала визита |
| `pageViews` | Глубина просмотра |
| `visitDuration` | Длительность визита (сек) |
| `regionCountry` | Страна |
| `browser`, `operatingSystemRoot` | Браузер и ОС |

---

## Часть 1: EDA — Что мы узнали?

| Вопрос | Ответ |
|-------|-------|
| Всего визитов | **387,353** |
| Период | 2021-01-01 → 2025-02-25 |
| Уникальных пользователей | **162,474** |
| Среднее визитов на пользователя | **2.38** |
| Максимум визитов | **58,700** (один пользователь!) |
| Топ страны | Россия, Сингапур, Китай |
| Топ браузеры | Chrome, Safari Mobile, Yandex Browser |
| Топ ОС | GNU/Linux, iOS, Android |

### Визуализации
- Динамика визитов по дням/месяцам
- Гистограммы глубины и длительности
- Топ-10 стран, браузеров, ОС
- Распределение по часам суток

---

## Часть 2: Дизайн A/B-экспериментов

### Цель
Оценить **возможности проведения A/B-тестов** на текущих данных:
- Какой **минимальный эффект (MDE)** мы можем обнаружить?
- Какова **мощность тестов**?
- Как **уменьшить дисперсию** метрик?

---

### Метрика A/B-теста


 **Средняя глубина просмотра** 


---

### Проверка корректности t-теста

Мы проверили **два типа t-тестов**:
1. **Абсолютный t-тест** — на абсолютное изменение среднего  
   → `H₀: μ_A = μ_B`
2. **Относительный t-тест** — на относительное изменение  
   → `H₀: μ_A / μ_B = 1`

**Результат**: Оба теста **корректны** (уровень значимости ≈ 5% при α = 0.05).

---

### Мощность и MDE


1. **Абсолютный t-тест** почти достигает достаточной мощности (≥80%) при эффекте в 10% от среднего значения метрики.
2. **Относительный t-тест** также демонстрирует корректное поведение и приемлемую мощность вблизи этого уровня эффекта.

---

## CUPED: Уменьшение дисперсии с помощью ковариат

### Что такое **CUPED**?

**CUPED (Controlled-experiment Using Pre-Experiment Data)** — метод снижения дисперсии метрик в A/B-тестах за счёт использования **предэкспериментальных данных**.

#### Идея:
Если у нас есть **исторические данные по пользователям до теста**, мы можем:
1. Вычислить **предэкспериментальную метрику** (`pre_metric`)
2. Использовать её как **ковариату** в регрессии
3. Скорректировать целевую метрику:  
   Y_CUPED = Y - θ · (X - X̄)  
   где:
   - `Y` — метрика в тесте
   - `X` — предэкспериментальная метрика
   - `θ` — коэффициент из регрессии `Y ~ X`

---

### Как мы применили CUPED?

#### Шаг 1: Разделение данных на периоды

Мы разделили данные на **два временных окна**:

| Период | Годы | Назначение |
|--------|------|----------|
| **Pre-period** | 2021–2022 | Исторические данные (ковариата) |
| **Post-period** | 2023–2024 | Данные "теста" (целевая метрика) |

> Это **имитация реального A/B-теста**: Pre — до изменений, Post — после.

#### Шаг 2: Агрегация по пользователям

Для каждого `clientID` посчитали:

```python
pre_metric = data[pre_period].groupby('clientID')['pageViews'].mean()
post_metric = data[post_period].groupby('clientID')['pageViews'].mean()
```

- `pre_metric` → **ковариата** (историческая активность)
- `post_metric` → **целевая метрика** (то, что тестируем)

#### Шаг 3: Обучение модели для оценки θ (коэффициента ковариации)

Мы использовали **CatBoostRegressor**, чтобы предсказать `post_metric` по `pre_metric`:

```python
from catboost import CatBoostRegressor

model = CatBoostRegressor(iterations=100, depth=4, learning_rate=0.1, verbose=0)
model.fit(pre_metric.values.reshape(-1, 1), post_metric.values)
```

> **Почему CatBoost?**  
> - Учитывает нелинейности  
> - Устойчив к выбросам  
> - Не требует масштабирования

#### Шаг 4: Расчёт θ и корректировка метрики

Классическая формула CUPED:

Y_CUPED = Y - θ · (X - X̄)

Где:
- Y — целевая метрика (post)
- X — ковариата (pre)
- X̄ — среднее по всем X
- θ — коэффициент из регрессии Y ~ X

```python
X = pre_metric.values
Y = post_metric.values
X_mean = X.mean()

theta = model.predict(X.reshape(-1, 1)).mean()  # Или: cov(Y,X)/var(X)
Y_cuped = Y - theta * (X - X_mean)
```

#### Шаг 5: Применение t-теста на скорректированной метрике

Теперь вместо обычного t-теста:

```python
from scipy.stats import ttest_ind
ttest_ind(control_cuped, treatment_cuped)
```

Мы используем **CUPED-метрику**, у которой **меньше дисперсия** → выше чувствительность.




### Другие методы уменьшения дисперсии

| Метод | Описание | 
|------|---------|
| **Стратификация** | Делим пользователей на страты (по pre-активности) |
| **Post-stratification** | Взвешивание после теста |
| **CUPAC (ML)** | CatBoost как ковариата | Лучше линейной регрессии |

---

## Вывод:

Мы провели полный цикл анализа данных о визитах пользователей сайта Физтех.Статистики (2020–2024 гг.) и построили симуляцию A/B-экспериментов.

1. **Исследовательский анализ (EDA)** показал основные характеристики трафика: общее количество визитов, динамику по дням, распределение глубины и длительности сессий, географию, топ браузеров и ОС.

2. **Проверка корректности и мощности тестов**  
   Проверили абсолютный и относительный t-тесты на симулированных данных. Оба теста показали корректный уровень значимости и приемлемую мощность.

3. **Методы уменьшения дисперсии**  
   Реализовали и сравнили:
   - стратификацию,
   - CUPED с использованием предэкспериментальных данных,
   - CUPED с CatBoost-регрессией.  

   **Вывод:** мы проверили корректность и мощность абсолютного и относительного т-теста и проверили, как в данном случае работают методы уменьшения дисперсии. Они в данном случае помогли, но не сильно: MDE удалось уменьшить примерно на 0.7%.


## Как запустить

```bash
git clone https://github.com/yourusername/pet-project-ab-testing.git
cd pet-project-ab-testing
pip install -r requirements.txt
jupyter notebook pet_project.ipynb
```

---

## Структура проекта

```
pet_project/
├── pet_project.ipynb        # Основной анализ + A/B + CUPED
├── data.tsv                 # Данные 
├── requirements.txt
├── images/                  # Графики
└── README.md
```

---

## Дальнейшие шаги (идеи)

- [ ] Применить **CUPAC** с несколькими ковариатами (pre-duration, pre-bounce и т.д.)
- [ ] Реализовать **sequential testing** (alpha-spending)
- [ ] Построить **дашборд** (Streamlit/Dash)
- [ ] Сравнить с **bootstrap** и **delta method**


---
